# 機能詳細設計

## C-01: セッション開始

### 機能概要
顧客がテーブルのQRコードをスキャンして、来店セッションを開始する。

### 処理フロー
1. QRコードスキャン → URLにアクセス
2. URLパラメータから`table_id`を取得
3. 既存のアクティブセッションがあるか確認
   - ある場合：既存セッションに自動参加、session_codeをローカルストレージに保存、メニュー一覧画面へ遷移
   - ない場合：来店人数入力画面を表示
4. 来店人数を入力
5. セッション作成（Session作成）
6. セッションコード（UUID）を生成
7. session_codeをローカルストレージに保存
8. Telegram Chat IDを記録
9. メニュー一覧画面へ遷移

### 入力
- `table_id`: テーブルID（QRコードURL内）
- `party_size`: 来店人数（1〜20人）
- `telegram_chat_id`: Telegram Chat ID

### 出力
- セッションコード
- セッション開始日時

### データベース操作
```sql
INSERT INTO Session (
  store_id, table_id, session_code, party_size, 
  telegram_chat_id, status, started_at
) VALUES (?, ?, ?, ?, ?, 'active', CURRENT_TIMESTAMP);
```

### バリデーション
- 来店人数：1〜20の整数
- テーブルIDの存在確認
- テーブルの利用可能状態確認
- 数量：1〜商品のmax_quantity_per_order（デフォルト10）

### エラーハンドリング
- テーブルが存在しない → エラーメッセージ表示
- テーブルが利用不可 → エラーメッセージ表示
- 入力値不正 → 再入力を促す

---

## C-02: メニュー閲覧

### 機能概要
カテゴリ別にメニューを表示。商品画像、名前、価格、説明を表示。

### 処理フロー
1. セッション情報からstore_idを取得
2. カテゴリ一覧を取得（display_order順）
3. デフォルトは最初のカテゴリを選択
4. 選択カテゴリの商品一覧を取得
5. 商品ごとにサムネイル画像、名前、価格を表示
6. 売り切れ商品はグレーアウト表示

### 入力
- `session_code`: セッションコード
- `category_id`: カテゴリID（オプション）

### 出力
- カテゴリ一覧
- 商品一覧（画像URL、名前、価格、売り切れフラグ）

### データベース操作
```sql
-- カテゴリ取得
SELECT id, name FROM Category 
WHERE store_id = ? AND is_active = 1 
ORDER BY display_order;

-- 商品取得
SELECT m.id, m.name, m.price, m.description, m.is_available,
       i.file_path AS thumbnail_path
FROM MenuItem m
LEFT JOIN MenuItemImage i ON m.id = i.menu_item_id AND i.image_type = 'thumbnail'
WHERE m.store_id = ? AND m.category_id = ? AND m.is_active = 1
ORDER BY m.display_order;
```

### 表示ルール
- サムネイル画像：400x300px
- 売り切れ商品：opacity: 0.5、「売り切れ」バッジ表示
- 画像なし商品：デフォルト画像（/static/images/no-image.png）表示

---

## C-03: 商品検索

### 機能概要
メニュー内を商品名で検索。

### 処理フロー
1. 検索キーワードを入力
2. 商品名に部分一致する商品を検索
3. 検索結果を一覧表示

### 入力
- `keyword`: 検索キーワード（1〜50文字）

### 出力
- 検索結果の商品一覧

### データベース操作
```sql
SELECT m.id, m.name, m.price, i.file_path AS thumbnail_path
FROM MenuItem m
LEFT JOIN MenuItemImage i ON m.id = i.menu_item_id AND i.image_type = 'thumbnail'
WHERE m.store_id = ? AND m.name LIKE ? AND m.is_active = 1 AND m.is_available = 1
ORDER BY m.name;
```

---

## C-04: 注文登録（カート追加）

### 機能概要
選択した商品をカートに追加。

### 処理フロー
1. 商品詳細画面で商品を選択
2. 数量を指定（1〜max_quantity_per_order、デフォルト10）
3. 備考を入力（オプション）
4. カートに追加ボタンをタップ
5. 数量制限チェック（max_quantity_per_orderを超えていないか）
6. セッションストレージにカート情報を保存
7. カートアイコンに数量バッジを表示

### 入力
- `menu_item_id`: メニューID
- `quantity`: 数量（1〜max_quantity_per_order）
- `note`: 備考（オプション、最大200文字）

### 出力
- カート内商品数

### バリデーション
- 数量が1以上、max_quantity_per_order以下であること
- max_quantity_per_orderがNULLの場合は99まで

### エラーハンドリング
- 数量超過: 「この商品は1回の注文で最大{max}個までです」

### データ保存
- クライアント側のセッションストレージに保存
- カート構造：
```json
{
  "items": [
    {
      "menu_item_id": 1,
      "name": "ハンバーグ定食",
      "price": 1200,
      "quantity": 2,
      "max_quantity": 10,
      "note": "アレルギー対応お願いします"
    }
  ]
}
```

---

## C-05: 注文確定

### 機能概要
カート内の商品を確定し、注文として登録。

### 処理フロー
1. カート画面でカート内容を確認
2. 注文確定ボタンをタップ
3. サーバーに注文データを送信
4. Order、OrderItemを作成
5. 注文番号を採番
6. 注文完了メッセージ表示
7. カートをクリア

### 入力
- `session_code`: セッションコード
- `telegram_user_id`: Telegram User ID
- `telegram_username`: Telegram Username
- `items`: 注文商品リスト

### 出力
- 注文ID
- 注文番号

### データベース操作
```sql
-- 注文番号採番
SELECT COALESCE(MAX(order_number), 0) + 1 
FROM Order WHERE session_id = ?;

-- Order作成
INSERT INTO Order (
  session_id, telegram_user_id, telegram_username, 
  order_number, total_amount, status, ordered_at
) VALUES (?, ?, ?, ?, ?, 'pending', CURRENT_TIMESTAMP);

-- OrderItem作成
INSERT INTO OrderItem (
  order_id, menu_item_id, menu_item_name, unit_price, 
  quantity, subtotal, note, status
) VALUES (?, ?, ?, ?, ?, ?, ?, 'pending');
```

### バリデーション
- カートが空でないこと
- 商品が提供可能状態であること
- 数量が1以上、max_quantity_per_order以下であること

### エラーハンドリング
- 売り切れ商品が含まれている → エラーメッセージ、該当商品を表示
- 数量が上限を超えている → エラーメッセージ「1回の注文で[商品名]は最大[数量]個までです」
- セッションが無効 → セッション再開を促す

---

## C-06: 追加注文

### 機能概要
既存セッション内で追加注文を行う。

### 処理フロー
- C-02〜C-05と同じフロー
- 新しいOrderとして登録される
- order_numberは連番で採番

---

## C-07: 注文履歴確認

### 機能概要
自分の注文履歴、またはテーブル全体の注文履歴を表示。

### 処理フロー
1. 「注文履歴」ボタンをタップ
2. タブ切替：「自分の注文」「全員の注文」
3. 注文一覧を表示（注文番号、商品、数量、金額、ステータス）

### 入力
- `session_code`: セッションコード
- `view_type`: 'mine' または 'all'
- `telegram_user_id`: Telegram User ID（view_type='mine'の場合）

### 出力
- 注文一覧（注文番号、注文日時、商品詳細、ステータス）

### データベース操作
```sql
-- 自分の注文
SELECT o.order_number, o.ordered_at, o.total_amount, o.status,
       oi.menu_item_name, oi.quantity, oi.unit_price, oi.status AS item_status
FROM Order o
JOIN OrderItem oi ON o.id = oi.order_id
WHERE o.session_id = ? AND o.telegram_user_id = ?
ORDER BY o.ordered_at DESC, oi.id;

-- 全員の注文
SELECT o.order_number, o.telegram_username, o.ordered_at, o.total_amount, o.status,
       oi.menu_item_name, oi.quantity, oi.unit_price, oi.status AS item_status
FROM Order o
JOIN OrderItem oi ON o.id = oi.order_id
WHERE o.session_id = ?
ORDER BY o.ordered_at DESC, oi.id;
```

### 表示ルール
- ステータス表示：
  - pending: 未調理
  - cooking: 調理中（オレンジ）
  - ready: 調理完了（青）
  - served: 提供済み（緑）

---

## C-08: 店員呼び出し

### 機能概要
店員を呼び出す。理由を選択し、メッセージを送信。

### 処理フロー
1. 「店員呼び出し」ボタンをタップ
2. 理由を選択（water, payment, question, complaint, other）
3. メッセージを入力（オプション）
4. 送信ボタンをタップ
5. StaffCall作成
6. 店舗側に通知
7. 呼び出し完了メッセージ表示

### 入力
- `session_code`: セッションコード
- `reason`: 理由（water, payment, question, complaint, other）
- `message`: メッセージ（オプション、最大500文字）

### 出力
- 呼び出しID

### データベース操作
```sql
INSERT INTO StaffCall (
  session_id, reason, message, status, called_at
) VALUES (?, ?, ?, 'pending', CURRENT_TIMESTAMP);
```

### 通知
- 店舗側の呼び出し画面にリアルタイム表示
- 音声アラート（オプション）

---

## C-09: 会計依頼

### 機能概要
会計を依頼し、合計金額を確認。会計依頼後に追加注文したい場合は会計キャンセル可能。

### 処理フロー
1. 「会計」ボタンをタップ
2. セッション内の全注文の合計金額を計算（cancelled以外）
3. 金額を表示
4. Payment作成
5. Session.statusを'payment_requested'に更新
6. 店舗側に通知

### 会計キャンセル（追加注文のため）
1. 会計画面で「キャンセルして追加注文」ボタンをタップ
2. Payment.statusを'cancelled'に更新
3. Session.statusを'active'に戻す
4. メニュー一覧へ遷移

### 入力
- `session_code`: セッションコード

### 出力
- 合計金額

### データベース操作
```sql
-- 合計金額計算
SELECT SUM(total_amount) FROM Order 
WHERE session_id = ? AND status != 'cancelled';

-- Payment作成
INSERT INTO Payment (
  session_id, total_amount, status, requested_at
) VALUES (?, ?, 'pending', CURRENT_TIMESTAMP);

-- Session更新
UPDATE Session SET status = 'payment_requested' WHERE id = ?;

-- 会計キャンセル
UPDATE Payment SET status = 'cancelled' WHERE session_id = ? AND status = 'pending';
UPDATE Session SET status = 'active' WHERE id = ?;
```

---

## C-10: セッション復帰

### 機能概要
Telegram Mini Appsを再度開いたときに、前回のセッションに復帰する。

### 処理フロー
1. アプリ起動時、ローカルストレージから`session_code`を取得
2. session_codeが存在する場合、サーバーにセッション有効性を確認
3. セッションが有効（status='active'または'payment_requested'）な場合
   - 確認画面を表示「前回のセッション（テーブル: {table_number}）に戻りますか？」
   - 「はい」→ メニュー一覧へ遷移
   - 「いいえ」→ ローカルストレージをクリア、QRスキャン画面へ
4. セッションが無効な場合
   - ローカルストレージをクリア
   - QRスキャン画面へ

### 入力
- `session_code`: ローカルストレージに保存されたセッションコード

### 出力
- セッション情報（テーブル番号、店舗名）

### データベース操作
```sql
-- セッション有効性確認
SELECT s.id, s.status, t.table_number, st.name AS store_name
FROM Session s
JOIN Table t ON s.table_id = t.id
JOIN Store st ON s.store_id = st.id
WHERE s.session_code = ? AND s.status IN ('active', 'payment_requested');
```

---

## A-01: ユーザー認証

### 機能概要
管理画面へのログイン・ログアウト。

### ログイン処理フロー
1. ログイン画面でusername, passwordを入力
2. Userテーブルから該当ユーザーを検索
3. パスワードハッシュを検証
4. 認証成功 → セッション作成、ダッシュボードへリダイレクト
5. 認証失敗 → エラーメッセージ表示

### 入力
- `username`: ユーザー名
- `password`: パスワード

### データベース操作
```sql
SELECT id, username, password_hash, role, store_id 
FROM User 
WHERE username = ? AND is_active = 1;
```

### セキュリティ
- パスワードはbcryptでハッシュ化
- ログイン試行回数制限（5回/5分）
- セッションタイムアウト：2時間

---

## A-02: ダッシュボード

### 機能概要
店舗全体の状況をサマリー表示。

### 表示内容
- アクティブセッション数
- 本日の注文件数
- 本日の売上
- 調理待ち注文数
- 店員呼び出し未対応件数

### データベース操作
```sql
-- アクティブセッション数
SELECT COUNT(*) FROM Session WHERE status = 'active';

-- 本日の注文件数
SELECT COUNT(*) FROM Order WHERE DATE(ordered_at) = CURRENT_DATE;

-- 本日の売上
SELECT SUM(total_amount) FROM Payment 
WHERE DATE(paid_at) = CURRENT_DATE AND status = 'paid';

-- 調理待ち注文数
SELECT COUNT(*) FROM Order WHERE status = 'pending';

-- 店員呼び出し未対応件数
SELECT COUNT(*) FROM StaffCall WHERE status = 'pending';
```

---

## A-03: 注文ダッシュボード

### 機能概要
リアルタイムで全注文を表示し、ステータスを管理。OrderItem単位で表示。

### 処理フロー
1. 注文一覧をOrderItem単位で取得（pending, cooking, ready順）
2. テーブル番号、注文番号、商品、数量、注文日時、経過時間、ステータスを表示
3. ステータス変更ボタンをクリック
4. OrderItemのstatusを更新
5. 画面を自動更新（5秒間隔）

### 表示項目
- テーブル番号
- 注文番号
- 商品名
- 数量
- 注文日時
- 経過時間
- ステータス
- アクションボタン
- キャンセルボタン（店舗側のみ）

### データベース操作
```sql
-- 注文一覧取得（OrderItem単位）
SELECT oi.id, o.order_number, o.ordered_at, oi.status, t.table_number,
       oi.menu_item_name, oi.quantity, o.telegram_username
FROM OrderItem oi
JOIN Order o ON oi.order_id = o.id
JOIN Session s ON o.session_id = s.id
JOIN Table t ON s.table_id = t.id
WHERE s.status IN ('active', 'payment_requested') 
  AND o.status != 'cancelled'
  AND oi.status IN ('pending', 'cooking', 'ready')
ORDER BY 
  CASE oi.status 
    WHEN 'pending' THEN 1 
    WHEN 'cooking' THEN 2 
    WHEN 'ready' THEN 3 
  END, 
  o.ordered_at;

-- ステータス更新（OrderItem単位）
UPDATE OrderItem SET status = ? WHERE id = ?;

-- 注文キャンセル（Order全体）
UPDATE Order SET status = 'cancelled', cancelled_at = CURRENT_TIMESTAMP, cancelled_by = ? WHERE id = ?;
UPDATE OrderItem SET status = 'cancelled' WHERE order_id = ?;
```

### 注文キャンセル機能
- 店舗側のみがOrderをキャンセル可能
- キャンセル理由は記録しない（運用で管理）
- キャンセルされたOrderは会計金額から除外

### 自動更新
- Ajax polling（5秒間隔）
- WebSocket（オプション）

---

## A-04: テーブル管理

### 機能概要
テーブルの登録、編集、QRコード生成。

### 処理フロー
1. テーブル一覧を表示
2. 「新規登録」ボタンをクリック
3. テーブル番号、定員を入力
4. 保存ボタンをクリック
5. QRコード用URLを自動生成
6. QRコード画像を生成
7. QRコードを表示・ダウンロード可能に

### 入力
- `table_number`: テーブル番号（例：A-1、1、テーブル1）
- `capacity`: 定員（1〜20）

### QRコードURL形式
```
https://{domain}/order?table={table_id}
```

### データベース操作
```sql
INSERT INTO Table (
  store_id, table_number, qr_code_url, capacity, is_available
) VALUES (?, ?, ?, ?, 1);
```

### QRコード生成
- Pythonライブラリ：qrcode
- 画像サイズ：300x300px
- 保存先：/media/qr_codes/{table_id}.png

---

## A-05: メニュー管理

### 機能概要
商品の登録、編集、削除、画像アップロード。

### 処理フロー（新規登録）
1. 「新規商品登録」ボタンをクリック
2. フォームに入力
   - 商品名
   - カテゴリ
   - 価格
   - 説明
   - 表示順序
3. 画像をドラッグ&ドロップ
4. プレビュー表示
5. 保存ボタンをクリック
6. MenuItem作成
7. 画像をアップロード、リサイズ
8. MenuItemImage作成（original, thumbnail, large）

### 入力
- `name`: 商品名（最大100文字）
- `category_id`: カテゴリID
- `price`: 価格（0.01〜99999.99）
- `description`: 説明（最大1000文字）
- `max_quantity_per_order`: 1注文あたりの最大数量（1〜99、デフォルト10）
- `display_order`: 表示順序
- `image`: 画像ファイル（JPEG, PNG, WebP、最大2MB、任意）

### 画像処理
1. 画像がアップロードされた場合：
   - オリジナル画像を保存
   - サムネイル生成（400x300px、品質85）
   - 大サイズ生成（800x600px、品質90）
   - EXIF情報を削除
   - 各画像のfile_path, file_size, width, heightを記録
2. 画像がアップロードされなかった場合：
   - デフォルト画像（/static/images/no-image.png）を使用

### データベース操作
```sql
-- MenuItem作成
INSERT INTO MenuItem (
  store_id, category_id, name, description, price, 
  max_quantity_per_order, display_order, is_available, is_active
) VALUES (?, ?, ?, ?, ?, ?, ?, 1, 1);

-- MenuItemImage作成（画像アップロード時のみ）
INSERT INTO MenuItemImage (
  menu_item_id, image_type, file_path, file_size, 
  width, height, mime_type, uploaded_at
) VALUES (?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP);
```

### バリデーション
- 商品名：必須、最大100文字
- 価格：必須、0.01以上
- max_quantity_per_order：1〜99、デフォルト10
- 画像：JPEG/PNG/WebP、最大2MB（任意）
- ファイル名：サニタイズ（../などの除去）

---

## A-06: カテゴリ管理

### 機能概要
カテゴリの登録、編集、削除、並び替え。

### 処理フロー
1. カテゴリ一覧を表示（display_order順）
2. ドラッグ&ドロップで並び替え
3. display_orderを更新
4. 新規登録・編集はモーダルで表示

### 入力
- `name`: カテゴリ名（最大50文字）
- `display_order`: 表示順序

### データベース操作
```sql
-- 並び替え
UPDATE Category SET display_order = ? WHERE id = ?;
```

---

## A-07: 売り切れ管理

### 機能概要
商品の提供可否をトグルで切替。

### 処理フロー
1. メニュー一覧でトグルボタンをクリック
2. is_availableを反転
3. 即座に反映

### データベース操作
```sql
UPDATE MenuItem SET is_available = ? WHERE id = ?;
```

---

## A-08: 店員呼び出し対応

### 機能概要
顧客からの呼び出しに対応。

### 処理フロー
1. 呼び出し一覧を表示（pending優先）
2. 呼び出しをクリックして詳細表示
3. 「対応開始」ボタンをクリック → status='in_progress'
4. 対応後「完了」ボタンをクリック → status='resolved'

### データベース操作
```sql
-- 対応開始
UPDATE StaffCall SET status = 'in_progress', responded_at = CURRENT_TIMESTAMP WHERE id = ?;

-- 完了
UPDATE StaffCall SET status = 'resolved', resolved_at = CURRENT_TIMESTAMP WHERE id = ?;
```

---

## A-09: 会計処理

### 機能概要
レシート印刷、会計完了登録。

### 処理フロー
1. セッション一覧から会計待ちを選択
2. 注文明細を表示
3. 「レシート印刷」ボタンをクリック
4. レシートPDFを生成・印刷
5. POSレジで支払い
6. 支払い方法を選択
7. 「会計完了」ボタンをクリック
8. Payment.statusを'paid'に更新
9. Session.statusを'completed'に更新

### レシート内容
- 店舗名
- テーブル番号
- 注文明細（商品名、数量、単価、小計）
- 合計金額
- 日時

### データベース操作
```sql
-- 会計完了
UPDATE Payment SET status = 'paid', payment_method = ?, paid_at = CURRENT_TIMESTAMP WHERE session_id = ?;
UPDATE Session SET status = 'completed', ended_at = CURRENT_TIMESTAMP WHERE id = ?;
```

---

## A-10: 売上管理

### 機能概要
日次・月次の売上レポート表示。

### 表示内容
- 売上合計
- 注文件数
- 客数
- 商品別売上ランキング
- 時間帯別売上グラフ

### データベース操作
```sql
-- 日次売上
SELECT DATE(paid_at) AS date, SUM(total_amount) AS total, COUNT(*) AS count
FROM Payment
WHERE status = 'paid' AND paid_at BETWEEN ? AND ?
GROUP BY DATE(paid_at);

-- 商品別売上
SELECT oi.menu_item_name, SUM(oi.quantity) AS qty, SUM(oi.subtotal) AS total
FROM OrderItem oi
JOIN Order o ON oi.order_id = o.id
WHERE o.ordered_at BETWEEN ? AND ?
GROUP BY oi.menu_item_name
ORDER BY total DESC
LIMIT 10;
```

---

## A-11: セッション管理

### 機能概要
アクティブセッション一覧の表示、強制終了。

### 処理フロー
1. アクティブセッション一覧を表示
2. テーブル番号、開始時刻、来店人数、注文数、合計金額を表示
3. 強制終了ボタンで異常終了可能

### データベース操作
```sql
SELECT s.id, t.table_number, s.started_at, s.party_size, s.status,
       COUNT(o.id) AS order_count, SUM(o.total_amount) AS total
FROM Session s
JOIN Table t ON s.table_id = t.id
LEFT JOIN Order o ON s.id = o.session_id
WHERE s.status IN ('active', 'payment_requested')
GROUP BY s.id;
```
