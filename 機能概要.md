# 機能概要

## システム概要
Telegram Bot/Mini Appsを活用した飲食店向けモバイルオーダーシステム。顧客はスマホから注文、店舗はブラウザで注文管理・調理ステータス管理を行う。

---

## 機能分類

### 1. 顧客向け機能（Telegram Mini Apps）
テーブルのQRコードをスキャンして利用開始。複数人が同時に注文可能。

| 機能ID | 機能名 | 概要 |
|--------|--------|------|
| C-01 | セッション開始 | QRコードスキャン、来店人数入力 |
| C-02 | メニュー閲覧 | カテゴリ別メニュー表示、商品画像表示 |
| C-03 | 商品検索 | メニュー内検索機能 |
| C-04 | 注文登録 | 商品選択、数量指定、カート追加 |
| C-05 | 注文確定 | カート内容確認、注文送信 |
| C-06 | 追加注文 | 追加でメニューから注文 |
| C-07 | 注文履歴確認 | 自分の注文・テーブル全体の注文履歴表示 |
| C-08 | 店員呼び出し | 理由選択、メッセージ送信 |
| C-09 | 会計依頼 | 会計ボタン、合計金額表示 |

### 2. 店舗管理機能（ブラウザ）
PCまたはタブレットのブラウザで利用。

| 機能ID | 機能名 | 概要 |
|--------|--------|------|
| A-01 | ユーザー認証 | ログイン、ログアウト |
| A-02 | ダッシュボード | 店舗全体の状況表示 |
| A-03 | 注文ダッシュボード | リアルタイム注文一覧、ステータス管理 |
| A-04 | テーブル管理 | テーブル登録、QRコード生成 |
| A-05 | メニュー管理 | 商品登録・編集・削除、画像アップロード |
| A-06 | カテゴリ管理 | カテゴリ登録・編集・並び替え |
| A-07 | 売り切れ管理 | 商品の提供可否切替 |
| A-08 | 店員呼び出し対応 | 呼び出し一覧、対応状況更新 |
| A-09 | 会計処理 | レシート印刷、会計完了登録 |
| A-10 | 売上管理 | 日次・月次売上レポート |
| A-11 | セッション管理 | アクティブセッション一覧 |

---

## 主要ユースケース

### UC-01: 来店から注文まで
**アクター**: 顧客

**前提条件**:
- Telegramアプリインストール済み
- Telegramにサインイン済み

**フロー**:
1. 顧客がテーブルのQRコードをスキャン
2. Telegram Mini Appsが起動
3. **既存アクティブセッションがある場合は自動参加、メニュー一覧へ直接遷移**
4. **既存セッションがない場合のみセッション開始画面表示**
5. 来店人数を入力して確定
6. メニュー一覧画面が表示される
7. カテゴリを選択、商品を閲覧
8. 商品をタップして詳細表示、数量選択（max_quantity_per_order以下）
9. カートに追加
10. カート画面で内容確認
11. 注文を確定
12. 注文完了メッセージ表示

**事後条件**:
- 注文がシステムに登録される
- 調理場ダッシュボードにOrderItem単位で表示される

---

### UC-02: グループ注文
**アクター**: 複数の顧客

**前提条件**:
- 既にセッションが開始されている

**フロー**:
1. 別の顧客が同じQRコードをスキャン
2. **既存セッションに自動参加、メニュー一覧へ直接遷移**
3. メニューから商品を選択
4. 各自が独立してカートに追加、注文確定
5. それぞれの注文が個別に登録される

**事後条件**:
- 複数の注文が同一セッションに紐づく
- 注文者ごとに注文履歴が記録される

---

### UC-03: 追加注文
**アクター**: 顧客

**前提条件**:
- 既に初回注文済み
- セッションがアクティブ

**フロー**:
1. 顧客がメニュー画面に戻る
2. 追加したい商品を選択
3. カートに追加、注文確定
4. 新しい注文として登録される

**事後条件**:
- 同一セッション内に新規注文が追加される
- 調理場ダッシュボードに新規注文表示

---

### UC-04: 調理から提供まで
**アクター**: 料理人、スーパーバイザ

**前提条件**:
- 顧客から注文が入っている

**フロー**:
1. 料理人が注文ダッシュボードで注文一覧を確認（OrderItem単位で表示）
2. 優先度の高い注文を選択
3. ステータスを「調理中」に変更
4. 調理を開始
5. 調理完了後、ステータスを「調理完了」に変更
6. **スーパーバイザが料理をチェック（完了後の待ち時間は特に管理しない）**
7. OKなら顧客テーブルへ提供
8. ステータスを「提供済み」に変更

**事後条件**:
- OrderItemのステータスが「提供済み」になる
- 全OrderItemが提供済みならOrderステータスも更新
- 顧客の注文履歴にも反映される

---

### UC-05: 店員呼び出し
**アクター**: 顧客、店員

**前提条件**:
- セッションがアクティブ

**フロー**:
1. 顧客が店員呼び出しボタンをタップ
2. 理由を選択（お水、会計、質問、苦情、その他）
3. 必要に応じてメッセージを入力
4. 呼び出しを送信
5. 店舗の呼び出し画面に通知表示
6. 店員が対応開始、ステータスを「対応中」に更新
7. 対応完了後、ステータスを「解決済み」に更新

**事後条件**:
- 呼び出し履歴が記録される
- 顧客に対応完了が通知される（オプション）

---

### UC-06: 会計処理
**アクター**: 顧客、レジ担当

**前提条件**:
- すべての注文が提供済み

**フロー**:
1. 顧客が会計ボタンをタップ
2. 合計金額が表示される
3. 会計依頼ボタンをタップ
4. Payment作成、Session.status='payment_requested'
5. **追加注文したい場合は会計キャンセルボタンをタップ**
6. **会計キャンセル後、追加注文してから再度会計依頼**
7. レシート印刷ボタンをタップ（店舗側）
8. レシートが印刷される
9. 顧客がレシートを持ってレジへ
10. レジ担当がPOSレジで支払い処理
11. 店舗側で会計完了を登録
12. セッションが終了

**事後条件**:
- セッションステータスが「完了」になる
- 売上データに記録される
- テーブルが再利用可能になる

---

### UC-07: メニュー管理
**アクター**: 管理者、店舗スタッフ

**前提条件**:
- 管理画面にログイン済み

**フロー**:
1. メニュー管理画面を開く
2. 「新規商品登録」ボタンをクリック
3. 商品情報を入力（名前、説明、価格、カテゴリ、最大数量）
4. **商品画像をドラッグ&ドロップでアップロード（任意）**
5. プレビューで確認
6. 保存ボタンをクリック
7. **画像がある場合は自動リサイズ、ない場合はデフォルト画像を使用**
8. データベースに保存

**事後条件**:
- 新商品がメニューに追加される
- 顧客向け画面に即座に反映される

---

### UC-08: 売り切れ管理
**アクター**: 店舗スタッフ

**前提条件**:
- 管理画面にログイン済み

**フロー**:
1. メニュー管理画面を開く
2. 売り切れにする商品を選択
3. 「売り切れ」トグルボタンをOFFに変更
4. 確認ダイアログで「OK」をクリック
5. 商品が売り切れ状態になる

**事後条件**:
- 該当商品が顧客向け画面でグレーアウト表示
- 注文不可になる

---

## 非機能要件

### パフォーマンス
- メニュー一覧の表示：3秒以内
- 注文確定のレスポンス：2秒以内
- 画像読み込み：遅延読み込み（Lazy Loading）対応
- 同時接続数：100セッション対応

### セキュリティ
- 管理画面はパスワード認証必須
- セッションコードはUUID v4使用
- 画像アップロードはファイル形式・サイズ検証
- XSS、CSRF対策実施

### ユーザビリティ
- スマホ画面に最適化（レスポンシブデザイン）
- タップ領域は最小44x44px
- 画像はWebP形式で配信（フォールバック対応）
- オフライン時のエラーメッセージ表示

### 可用性
- システム稼働率：99%以上
- データバックアップ：日次実施
- エラーログ記録

---

## 技術スタック

### バックエンド
- **言語**: Python 3.10+
- **フレームワーク**: Django 4.2+
- **データベース**: SQLite（開発）、PostgreSQL（本番推奨）
- **画像処理**: Pillow

### フロントエンド
- **顧客向け**: Telegram Mini Apps（HTML/CSS/JavaScript）
- **管理画面**: Django Templates + Bootstrap 5
- **画像表示**: Lazy Loading、WebP対応

### インフラ
- **開発環境**: ローカルサーバー
- **本番環境**: VPS推奨（Nginx + Gunicorn）
- **画像保存**: ローカルストレージ（/media/）
