# 仕様確認事項まとめ

## 確定した仕様

### 1. セッション管理
- **既存セッション参加**: 同一テーブルで既にアクティブなセッションがある場合、後から来た顧客は自動的に参加（来店人数入力画面をスキップし、直接メニュー一覧へ遷移）
- **セッション復帰**: Telegram Mini Appsを閉じた後、再度開いた場合、セッション情報を保持し「前回のセッションに戻りますか？」という確認画面を表示してから復帰

### 2. 注文管理
- **注文キャンセル**: 店舗側（管理画面）のみで可能。顧客側からはキャンセル不可
- **数量制限**: 商品ごとに1回の注文での最大数量を設定可能（MenuItem.max_quantity_per_order、デフォルト10個）
- **注文ダッシュボード表示**: OrderItem単位で表示（商品ごとに1行ずつ表示）

### 3. 会計管理
- **会計依頼後の追加注文**: 会計依頼を一旦キャンセルしてから追加注文可能
  - 会計依頼後は「会計をキャンセル」ボタンを表示
  - キャンセルするとSession.statusが'active'に戻り、追加注文可能になる
  - 追加注文後、再度会計依頼が可能

### 4. 商品管理
- **商品画像**: アップロードは任意項目
  - 画像アップロードした場合：自動で3サイズ生成（original, thumbnail, large）
  - 画像アップロードしない場合：デフォルト画像（/static/images/no-image.png）を表示

### 5. 調理管理
- **調理完了後の待ち時間**: 特に管理しない
  - 調理完了（status='ready'）から提供までの時間は測定・警告しない
  - スーパーバイザの判断に任せる

---

## データモデルへの反映

### MenuItem テーブルに追加
- `max_quantity_per_order`: INTEGER, NOT NULL, DEFAULT 10

### Order テーブルに追加
- `cancelled_at`: DATETIME, NULL
- `cancelled_by`: INTEGER, FK → User(id), NULL

### Session ステータス値の補足
- `payment_requested`: 会計依頼中（この状態でも会計キャンセル後に追加注文可能）

### Order/OrderItem ステータス値の補足
- `cancelled`: キャンセル（管理画面からのみ可能）

---

## 画面設計への反映

### C-S01: セッション開始画面
- 既存アクティブセッションがある場合、この画面をスキップしてメニュー一覧へ自動遷移
- セッション情報をlocalStorageに保存

### C-S02: メニュー一覧画面
- 会計依頼中（payment_requested）の場合、フッターに「会計をキャンセル」ボタンを表示
- 画像なし商品はデフォルト画像を表示

### C-S03: 商品詳細画面
- 数量選択は1〜max_quantity_per_order（商品ごとに異なる）
- max_quantity_per_orderに達したら+ボタンを無効化

### C-S04: カート画面
- 数量超過エラー表示：「[商品名] は1回の注文で最大[数量]個までです」

### C-S08: 会計画面
- 会計依頼前：「会計を依頼する」ボタン
- 会計依頼後：「会計をキャンセル」ボタン表示、追加注文したい場合の案内文を追加

### A-S03: 注文ダッシュボード
- OrderItem単位で1行ずつ表示
- 経過時間の色分けなし
- キャンセルボタンを追加（Order全体をキャンセル、管理者のみ）

### A-S07: 商品登録・編集画面
- 「1回の注文での最大数量」入力欄を追加（デフォルト10）
- 商品画像を任意項目に変更
- 画像なしでも登録可能

---

## 機能仕様への反映

### C-01: セッション開始
- 既存アクティブセッションの確認処理を追加
- セッション情報のlocalStorage保存処理を追加

### C-04: 注文登録（カート追加）
- max_quantity_per_orderのバリデーションを追加

### C-05: 注文確定
- 数量超過エラーハンドリングを追加

### C-09: 会計依頼
- 会計キャンセル機能を追加
- Payment削除、Session.status更新のSQL追加

### A-03: 注文ダッシュボード
- OrderItem単位での取得SQLに変更
- Orderステータス連動更新ロジックを追加
- 注文キャンセル機能を追加

### A-05: メニュー管理
- max_quantity_per_orderのINSERT/UPDATEを追加
- 画像アップロード任意化の処理分岐を追加

---

## その他の考慮事項

### セキュリティ
- 注文キャンセルは管理画面でのみ可能
- キャンセル実行者（User.id）を記録

### パフォーマンス
- 注文ダッシュボードはOrderItem単位で表示するため、件数が増える
- インデックス最適化が重要

### ユーザビリティ
- 会計キャンセル時の確認ダイアログで誤操作を防止
- 数量制限到達時の明確なフィードバック

### 将来の拡張性
- 商品ごとの数量制限を柔軟に設定可能
- セッション復帰機能により、顧客の利便性向上
