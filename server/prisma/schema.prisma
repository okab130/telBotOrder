// Prisma Schema - PostgreSQL Database Design

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ユーザー管理 ====================

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String?  @unique
  password  String
  role      UserRole @default(STAFF)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  callResponses StaffCallResponse[]

  @@map("users")
}

enum UserRole {
  ADMIN
  CHEF
  STAFF
}

// ==================== テーブル管理 ====================

model Table {
  id        String   @id @default(cuid())
  number    String   @unique
  capacity  Int      @default(4)
  qrCode    String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions Session[]

  @@map("tables")
}

// ==================== セッション管理 ====================

model Session {
  id            String        @id @default(cuid())
  tableId       String
  partySize     Int
  status        SessionStatus @default(ACTIVE)
  startTime     DateTime      @default(now())
  endTime       DateTime?
  totalAmount   Decimal       @default(0) @db.Decimal(10, 2)
  paymentMethod String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  table       Table        @relation(fields: [tableId], references: [id])
  orders      Order[]
  staffCalls  StaffCall[]

  @@index([tableId])
  @@index([status])
  @@map("sessions")
}

enum SessionStatus {
  ACTIVE
  PAYMENT_REQUESTED
  COMPLETED
  CANCELLED
}

// ==================== カテゴリ管理 ====================

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  displayOrder Int     @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  menuItems MenuItem[]

  @@map("categories")
}

// ==================== メニュー管理 ====================

model MenuItem {
  id           String   @id @default(cuid())
  categoryId   String
  name         String
  description  String?
  price        Decimal  @db.Decimal(10, 2)
  imageUrl     String?
  maxQuantity  Int      @default(10)
  isSoldOut    Boolean  @default(false)
  isActive     Boolean  @default(true)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  category   Category    @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]

  @@index([categoryId])
  @@index([isSoldOut])
  @@map("menu_items")
}

// ==================== 注文管理 ====================

model Order {
  id           String      @id @default(cuid())
  sessionId    String
  orderNumber  Int
  totalAmount  Decimal     @default(0) @db.Decimal(10, 2)
  status       OrderStatus @default(PENDING)
  note         String?
  orderedAt    DateTime    @default(now())
  completedAt  DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  session    Session     @relation(fields: [sessionId], references: [id])
  orderItems OrderItem[]

  @@unique([sessionId, orderNumber])
  @@index([sessionId])
  @@index([status])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  PREPARING
  READY
  SERVED
  CANCELLED
}

// ==================== 注文明細 ====================

model OrderItem {
  id         String          @id @default(cuid())
  orderId    String
  menuItemId String
  quantity   Int             @default(1)
  unitPrice  Decimal         @db.Decimal(10, 2)
  subtotal   Decimal         @db.Decimal(10, 2)
  status     OrderItemStatus @default(PENDING)
  note       String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  // Relations
  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@index([orderId])
  @@index([status])
  @@map("order_items")
}

enum OrderItemStatus {
  PENDING
  PREPARING
  READY
  SERVED
  CANCELLED
}

// ==================== 店員呼び出し ====================

model StaffCall {
  id        String          @id @default(cuid())
  sessionId String
  reason    StaffCallReason
  message   String?
  status    StaffCallStatus @default(PENDING)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  // Relations
  session   Session              @relation(fields: [sessionId], references: [id])
  responses StaffCallResponse[]

  @@index([sessionId])
  @@index([status])
  @@map("staff_calls")
}

enum StaffCallReason {
  WATER
  PAYMENT
  QUESTION
  COMPLAINT
  OTHER
}

enum StaffCallStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
}

model StaffCallResponse {
  id          String   @id @default(cuid())
  staffCallId String
  userId      String
  action      String
  createdAt   DateTime @default(now())

  // Relations
  staffCall StaffCall @relation(fields: [staffCallId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])

  @@index([staffCallId])
  @@map("staff_call_responses")
}
